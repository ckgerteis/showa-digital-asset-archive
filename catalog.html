<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Catalog | Showa Digital Archive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #fdfbf7; font-family: 'Roboto', sans-serif; }
        h1, h2, h3 { font-family: 'Merriweather', serif; color: #2c3e50; }
        .filter-section { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .asset-card img { height: 200px; object-fit: cover; }
        
        /* Custom Badge Colors */
        .badge-era { background-color: #c0392b; /* Muted Red */ }
        .badge-cat { background-color: #2c3e50; /* Navy */ }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Showa Digital Asset Archive</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="catalog.html">Catalog</a></li>
                    <li class="nav-item"><a class="nav-link" href="educators.html">Research & Education</a></li>
                    <li class="nav-item"><a class="nav-link" href="submit.html">Submit Entry</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h2>Archive Catalog</h2>
                <p class="text-muted">Explore <span id="count">0</span> digital assets from the Showa Era.</p>
            </div>
        </div>

        <div class="row mb-5 justify-content-center">
            <div class="col-lg-10">
                <div class="filter-section d-flex flex-wrap gap-3 align-items-end">
                    
                    <div class="flex-grow-1">
                        <label class="form-label fw-bold small">Search</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search title, notes, or tags...">
                    </div>

                    <div style="min-width: 220px;">
                        <label class="form-label fw-bold small">Historical Period</label>
                        <select id="eraFilter" class="form-select">
                            <option value="All">All Periods</option>
                            <option value="1926_1945">Interwar / Wartime (1926-45)</option>
                            <option value="1945_1952">Occupation / Reconstruction (1945-52)</option>
                            <option value="1952_1973">High Growth (1952-73)</option>
                            <option value="1973_1985">Restructuring (1973-89)</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
            </div>
        </div>

        <div id="catalogGrid" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading Archive Data...</p>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light py-4 text-center mt-5">
        <div class="container">
            <small>&copy; 2025 Showa Digital Asset Archive.</small>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <script>
        let allData = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Fetch the YAML file from the catalog folder
            fetch('catalog/fab.yml')
                .then(response => {
                    if (!response.ok) throw new Error("HTTP error " + response.status);
                    return response.text();
                })
                .then(yamlText => {
                    try {
                        // Parse YAML into a JavaScript Object
                        allData = jsyaml.load(yamlText);
                        renderGrid(allData);
                    } catch (e) {
                        console.error("YAML Parsing Error:", e);
                        document.getElementById('catalogGrid').innerHTML = `<div class="alert alert-danger col-12">Error parsing YAML file. Please check the console for details.</div>`;
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    document.getElementById('catalogGrid').innerHTML = `<div class="alert alert-danger col-12">Could not find 'catalog/fab.yml'. Ensure the file exists.</div>`;
                });
        });

        // Function to Draw the Cards
        function renderGrid(data) {
            const grid = document.getElementById('catalogGrid');
            const countSpan = document.getElementById('count');
            
            // Handle Empty Results
            if (!data || data.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted p-5"><h4>No matching assets found.</h4></div>';
                countSpan.innerText = "0";
                return;
            }

            countSpan.innerText = data.length;
            grid.innerHTML = '';

            data.forEach(item => {
                // 1. DATA MAPPING (Connecting YAML keys to Variables)
                const title = item.title || "Untitled Asset";
                const desc = item.historical_notes || "No historical notes provided.";
                const url = item.source_url || "#";
                
                // Handle Tags (which are arrays in your YAML)
                // We take the first tag, clean up underscores/numbers, and use it as the badge
                const eras = Array.isArray(item.period_tags) ? item.period_tags : [item.period_tags];
                const displayEra = eras[0] ? eras[0].replace(/_/g, ' ').replace(/\d+/g, '').trim() : "Unknown Era";
                
                const cats = Array.isArray(item.object_tags) ? item.object_tags : [item.object_tags];
                const displayCat = cats[0] || "General";

                // Image Fallback: If 'image' key is missing in YAML, generate a placeholder
                const imgUrl = item.image || `https://placehold.co/600x400/2c3e50/white?text=${encodeURIComponent(title.substring(0,15))}`;

                // 2. HTML TEMPLATE
                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm asset-card border-0">
                            <img src="${imgUrl}" class="card-img-top" alt="${title}" loading="lazy">
                            <div class="card-body">
                                <div class="mb-2">
                                    <span class="badge badge-era text-uppercase" style="font-size:0.7rem">${displayEra}</span>
                                    <span class="badge badge-cat text-uppercase" style="font-size:0.7rem">${displayCat}</span>
                                </div>
                                <h5 class="card-title text-truncate" title="${title}">${title}</h5>
                                <p class="card-text text-muted small" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${desc}
                                </p>
                            </div>
                            <div class="card-footer bg-white border-top-0 pb-3">
                                <a href="${url}" target="_blank" class="btn btn-outline-dark btn-sm w-100">View on Sketchfab &rarr;</a>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        // Function to Filter Data
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const eraFilter = document.getElementById('eraFilter').value; // e.g., "1926_1945"

            const filtered = allData.filter(item => {
                // Prepare item data for safe comparison
                const iTitle = (item.title || "").toLowerCase();
                const iNotes = (item.historical_notes || "").toLowerCase();
                
                // Convert array tags to a single string for easy checking
                const iEras = Array.isArray(item.period_tags) ? item.period_tags.join(" ") : (item.period_tags || "");
                
                // 1. Text Search Match
                const matchSearch = iTitle.includes(search) || iNotes.includes(search);

                // 2. Dropdown Filter Match (Partial match because tags are complex strings)
                const matchEra = eraFilter === 'All' || iEras.includes(eraFilter);

                return matchSearch && matchEra;
            });

            renderGrid(filtered);
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('eraFilter').addEventListener('change', applyFilters);

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('eraFilter').value = 'All';
            renderGrid(allData);
        }
    </script>
</body>
</html>