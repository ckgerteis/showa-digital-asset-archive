<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog | Showa Digital Archive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body { background-color: #fdfbf7; font-family: 'Roboto', sans-serif; }
        h1, h2, h3 { font-family: 'Merriweather', serif; color: #2c3e50; }
        .filter-section { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .asset-card { transition: transform 0.2s; }
        .asset-card:hover { transform: translateY(-2px); }
        .asset-card img { 
            height: 200px; 
            object-fit: cover; 
            background-color: #eee;
        }
        
        .badge-era { background-color: #c0392b; }
        .creator-text { font-size: 0.85rem; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Showa Digital Asset Archive</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="catalog.html">Catalog</a></li>
                    <li class="nav-item"><a class="nav-link" href="educators.html">Research</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h2>Archive Catalog</h2>
                <p class="text-muted">Index of <span id="count">0</span> external digital assets.</p>
            </div>
        </div>

        <div class="row mb-5 justify-content-center">
            <div class="col-lg-10">
                <div class="filter-section d-flex flex-wrap gap-3">
                    <input type="text" id="searchInput" class="form-control w-50" placeholder="Search title, creator...">
                    <select id="eraFilter" class="form-select w-25">
                        <option value="All">All Periods</option>
                        <option value="1926_1945">Interwar (1926-45)</option>
                        <option value="1945_1952">Occupation (1945-52)</option>
                        <option value="1952_1973">High Growth (1952-73)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="catalogGrid" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Connecting to Index...</p>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light py-5 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h5>Showa Digital Asset Archive</h5>
                    <small>Preserving the material heritage of modern Japan.</small>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small text-white-50">
                        <strong>Disclaimer:</strong> This site is a curated index of links. 
                        All 3D models, images, and intellectual property displayed via external APIs 
                        remain the property of their respective creators and hosting platforms (e.g., Sketchfab).
                        We do not host or claim ownership of these assets.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <script>
        let allData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetch('catalog/fab.yml')
                .then(r => r.text())
                .then(text => {
                    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                    allData = jsyaml.load(text);
                    renderGrid(allData);
                })
                .catch(e => console.error(e));
        });

        function renderGrid(data) {
            const grid = document.getElementById('catalogGrid');
            const countSpan = document.getElementById('count');
            
            if (!data || data.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center p-5">No assets found.</div>';
                countSpan.innerText = "0";
                return;
            }

            countSpan.innerText = data.length;
            grid.innerHTML = '';

            data.forEach((item, index) => {
                const uniqueId = `img-${index}`;
                const title = item.title || "Untitled";
                const url = item.source_url || "#";
                const creator = item.creator || "Unknown Creator";
                
                // Initial "Loading" State
                let imgUrl = `https://placehold.co/600x400/f0f0f0/999?text=Loading+Preview...`;

                const card = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 asset-card">
                            <div style="position: relative;">
                                <img id="${uniqueId}" src="${imgUrl}" class="card-img-top" alt="Preview of ${title}">
                                <span class="badge badge-era position-absolute top-0 end-0 m-2">
                                    ${(item.period_tags?.[0] || "").replace(/_/g,' ').replace(/\d+/g,'')}
                                </span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-truncate mb-1">${title}</h5>
                                <p class="creator-text mb-2"><i class="bi bi-person-circle"></i> ${creator}</p>
                                <p class="card-text text-muted small" style="line-height: 1.4;">
                                    ${(item.historical_notes || "").substring(0, 90)}...
                                </p>
                            </div>
                            <div class="card-footer bg-white border-0 pt-0 pb-3">
                                <a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm w-100">
                                    View on Sketchfab <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;

                // Securely fetch thumbnail via proxy
                if (url.includes('sketchfab.com')) {
                    fetchThumbnail(url, uniqueId);
                }
            });
        }

        async function fetchThumbnail(modelUrl, imgId) {
            try {
                // Using Noembed (Open Source oEmbed Proxy)
                const apiUrl = `https://noembed.com/embed?url=${encodeURIComponent(modelUrl)}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.thumbnail_url) {
                    const img = document.getElementById(imgId);
                    if(img) img.src = data.thumbnail_url;
                }
            } catch (err) {
                console.warn("Thumbnail fetch failed for", modelUrl);
            }
        }

        // Filter Logic
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allData.filter(i => 
                (i.title||"").toLowerCase().includes(term) || 
                (i.creator||"").toLowerCase().includes(term)
            );
            renderGrid(filtered);
        });
    </script>
</body>
</html>
